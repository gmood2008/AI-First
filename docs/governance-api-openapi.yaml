openapi: 3.0.0
info:
  title: AI-First Governance Platform API
  version: v3.0.0
  description: |
    Governance Platform API - 完整治理系统 API
    
    核心原则：
    - API 主权：所有治理逻辑、状态机、校验、权限判断，必须只存在于 API 层
    - UI 只是 API 的一个客户端示例
    - 如果 Web Console 消失，治理系统仍然完整运行

servers:
  - url: http://localhost:8080/api/governance
    description: Local development server

paths:
  # Part 1.1: Capability Governance
  /capabilities:
    get:
      summary: 获取所有能力列表
      description: 返回所有已注册的能力及其基本信息
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CapabilitySummary'
  
  /capabilities/{id}:
    get:
      summary: 获取单个能力详情
      description: 返回完整的能力信息，包括规范、健康度、生命周期状态、风险信息
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CapabilityDetail'
  
  /capabilities/{id}/health:
    get:
      summary: 获取能力健康度
      description: |
        ⚠️ 注意：Health 由 API 计算，UI 严禁本地计算
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CapabilityHealth'
  
  /capabilities/{id}/signals:
    get:
      summary: 获取能力的信号时间线
      description: |
        ⚠️ 注意：Signals 由 API 提供，UI 严禁本地计算
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Signal'
  
  /capabilities/{id}/lifecycle:
    get:
      summary: 获取能力生命周期信息
      description: |
        ⚠️ 注意：Lifecycle 由 API 提供，UI 严禁本地计算
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LifecycleInfo'
  
  # Part 1.2: Governance Proposals
  /proposals:
    get:
      summary: 获取提案列表
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [PENDING, APPROVED, REJECTED, EXPIRED]
        - name: proposal_type
          in: query
          schema:
            type: string
            enum: [FIX, SPLIT, FREEZE, PROMOTE, DEPRECATE]
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/GovernanceProposal'
  
  /proposals/{id}:
    get:
      summary: 获取单个提案详情
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProposalDetail'
  
  /proposals/{id}/approve:
    post:
      summary: 批准提案
      description: |
        要求：
        - decided_by: 决策者（必需）
        - rationale: 理由（必需）
        - role: 角色（可选，用于权限检查）
        
        返回：
        - 决策记录（GDR）
        - 状态变更结果
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProposalDecision'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GovernanceDecisionRecord'
  
  /proposals/{id}/reject:
    post:
      summary: 拒绝提案
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProposalDecision'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GovernanceDecisionRecord'
  
  # Part 1.3: Governance Decision Record
  /decisions:
    get:
      summary: 获取所有决策记录
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
        - name: capability_id
          in: query
          schema:
            type: string
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/GovernanceDecisionRecord'
  
  /decisions/{id}:
    get:
      summary: 获取单个决策记录
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GovernanceDecisionRecord'
  
  # V1: Observatory APIs
  /capabilities/risk-distribution:
    get:
      summary: 获取风险分布
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RiskDistribution'
  
  /signals:
    get:
      summary: 获取信号时间线
      parameters:
        - name: capability_id
          in: query
          schema:
            type: string
        - name: signal_type
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Signal'
  
  /demand/missing-capabilities:
    get:
      summary: 获取缺失能力列表
      parameters:
        - name: window_hours
          in: query
          schema:
            type: integer
            default: 24
        - name: min_frequency
          in: query
          schema:
            type: integer
            default: 1
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/MissingCapability'

components:
  schemas:
    CapabilitySummary:
      type: object
      properties:
        capability_id:
          type: string
        name:
          type: string
        description:
          type: string
        risk_level:
          type: string
          enum: [LOW, MEDIUM, HIGH, CRITICAL]
        current_state:
          type: string
          enum: [PROPOSED, ACTIVE, DEGRADING, FROZEN, DEPRECATED]
        health_score:
          type: number
          format: float
    
    CapabilityDetail:
      type: object
      properties:
        capability_id:
          type: string
        spec:
          type: object
        health:
          $ref: '#/components/schemas/CapabilityHealth'
        lifecycle:
          $ref: '#/components/schemas/LifecycleInfo'
        risk:
          type: object
          properties:
            level:
              type: string
    
    CapabilityHealth:
      type: object
      properties:
        capability_id:
          type: string
        current_state:
          type: string
        reliability_score:
          type: number
          format: float
        friction_score:
          type: number
          format: float
        last_incident_at:
          type: string
          format: date-time
          nullable: true
        last_state_change_at:
          type: string
          format: date-time
          nullable: true
    
    LifecycleInfo:
      type: object
      properties:
        capability_id:
          type: string
        current_state:
          type: string
        is_executable:
          type: boolean
        state_history:
          type: array
          items:
            type: object
    
    Signal:
      type: object
      properties:
        signal_id:
          type: string
        capability_id:
          type: string
        workflow_id:
          type: string
          nullable: true
        signal_type:
          type: string
        severity:
          type: string
          enum: [LOW, MEDIUM, HIGH, CRITICAL]
        source:
          type: string
        timestamp:
          type: string
          format: date-time
        metadata:
          type: object
    
    GovernanceProposal:
      type: object
      properties:
        proposal_id:
          type: string
        proposal_type:
          type: string
          enum: [FIX, SPLIT, FREEZE, PROMOTE, DEPRECATE]
        target_capability_id:
          type: string
        triggering_evidence:
          type: object
        created_at:
          type: string
          format: date-time
        created_by:
          type: string
        status:
          type: string
          enum: [PENDING, APPROVED, REJECTED, EXPIRED]
    
    ProposalDetail:
      allOf:
        - $ref: '#/components/schemas/GovernanceProposal'
        - type: object
          properties:
            decision_record:
              $ref: '#/components/schemas/GovernanceDecisionRecord'
              nullable: true
    
    ProposalDecision:
      type: object
      required:
        - decided_by
        - rationale
      properties:
        decided_by:
          type: string
        rationale:
          type: string
        role:
          type: string
    
    GovernanceDecisionRecord:
      type: object
      properties:
        decision_id:
          type: string
        proposal_id:
          type: string
        decision:
          type: string
          enum: [APPROVE, REJECT]
        decided_by:
          type: string
        decided_at:
          type: string
          format: date-time
        rationale:
          type: string
        affected_capabilities:
          type: array
          items:
            type: string
        resulting_state_transition:
          type: object
          nullable: true
        metadata:
          type: object
    
    RiskDistribution:
      type: object
      properties:
        distribution:
          type: object
          additionalProperties:
            type: integer
        total:
          type: integer
        by_risk:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
    
    MissingCapability:
      type: object
      properties:
        capability_id:
          type: string
        frequency:
          type: integer
        first_seen:
          type: string
          format: date-time
        last_seen:
          type: string
          format: date-time
        signals:
          type: array
          items:
            type: object
